# Weblogic 任意文件上传漏洞 (CVE-2018-2894)

## 漏洞详情

Oracle 7月更新中，修复了Weblogic Web Service Test Page中一处任意文件上传漏洞，Web Service Test Page 在“生产模式”下默认不开启，所以该漏洞有一定限制。

攻击者访问config.do配置页面，先更改Work Home工作目录，用有效的已部署的Web应用目录替换默认的存储JKS Keystores文件的目录，之后使用"添加Keystore设置"的功能，可上传恶意的JSP脚本文件



## 影响版本

**weblogic 10.3.6.0、weblogic 12.1.3.0、weblogic 12.2.1.2、weblogic 12.2.1.3**



## 环境搭建

```
cd 
docker-compose up -d
```



## 漏洞复现

环境启动后，访问`http://your-ip:7001/console`，即可看到后台登录页面

执行`docker-compose logs | grep password`可查看管理员密码，管理员用户名为`weblogic`，我们进行登录

在登录后台页面，点击`base_domain`的配置，在 ‘高级’ 中勾选 ‘启用 Web 服务测试页’ 选项，然后保存配置

![image-20210413194657128](images/Weblogic%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%20(CVE-2018-2894).assets/image-20210413194657128.png)

我们访问`/ws_utc/config.do` 目录，设置Work Home Dir为，进行保存

```
/u01/oracle/user_projects/domains/base_domain/servers/AdminServer/tmp/_WL_internal/com.oracle.webservices.wls.ws-testclient-app-wls/4mcj4y/war/css
```

**注意：**将目录设置为`ws_utc`应用的静态文件css目录，访问这个目录是无需权限的，这一点很重要



然后点击安全 -> 增加，然后上传webshell，这里我们用哥斯拉生成一个webshell的jsp，注意上传成功后抓取返回包，其中有时间戳：

![image-20210413195159164](images/Weblogic%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%20(CVE-2018-2894).assets/image-20210413195159164.png)

然后访问`http://your-ip:7001/ws_utc/css/config/keystore/[时间戳]_[文件名]`，即可执行webshell：

![image-20210413194445915](images/Weblogic%20%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%20(CVE-2018-2894).assets/image-20210413194445915.png)



## 漏洞分析

系统把所选的上传文件传到了storePath目录里，文件命名条件为fileNamePrefix + "_" + attachName，采用了POST请求中URL地址上携带的参数timestamp的值加上下划线拼接起来的文件名，同时也没有发现有任何过滤和检查。



## 防御与修复

1. 设置config.do,begin.do页面登录授权后访问；
2. IPS等防御产品可以加入相应的特征；
3. 升级到官方的最新版本；



